name: Manual Notebook CI

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Execution profile"
        required: true
        default: "fast"
        type: choice
        options:
          - fast
          - full

jobs:
  execute-notebooks:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-file: env.yml
          environment-name: rges-pit-dc
          cache-environment: false
          cache-downloads: true

      - name: Install runner + transformer deps
        shell: bash -l {0}
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml nbclient nbformat

      - name: Debug environment (versions)
        shell: bash -l {0}
        run: |
          python -V
          python -c "import sys; print(sys.executable)"
          python -m pip --version

      - name: Rebuild Nexus-ready notebooks (RRN/build)
        shell: bash -l {0}
        run: |
          rm -rf RRN/build
          python scripts/notebook_transformer.py --force

      - name: Verify CI skip tags (NEXUS-ONLY)
        shell: bash -l {0}
        run: |
          python - <<'PY'
          import glob
          import json
          import sys

          def cell_text(cell):
              src = cell.get('source', '')
              return ''.join(src) if isinstance(src, list) else str(src)

          bad = []
          for path in sorted(glob.glob('RRN/build/*.ipynb')):
              nb = json.loads(open(path, 'r', encoding='utf-8').read())
              for idx, cell in enumerate(nb.get('cells', []), start=1):
                  if cell.get('cell_type') != 'code':
                      continue
                  text = cell_text(cell)
                  if ('NEXUS-ONLY' in text) or ('%source' in text):
                      tags = cell.get('metadata', {}).get('tags', []) or []
                      if 'ci-skip' not in tags:
                          bad.append((path, idx, tags))
          if bad:
              for path, idx, tags in bad:
                  print(f"[ci] missing ci-skip tag: {path} cell {idx} tags={tags}")
              sys.exit(1)
          print('[ci] verified: all Nexus-only cells include ci-skip')
          PY

      - name: Execute notebooks
        shell: bash -l {0}
        run: |
          # Always skip CI-only and Nexus-only cells.
          SKIP_TAGS="ci-skip"
          if [ "${{ inputs.profile }}" = "fast" ]; then
            SKIP_TAGS="${SKIP_TAGS},slow"
          fi

          echo "[ci] using skip tags: ${SKIP_TAGS}"

          python scripts/execute_notebooks_ci.py \
            --glob "RRN/build/*.ipynb" \
            --skip-tags "$SKIP_TAGS" \
            --timeout 1800
