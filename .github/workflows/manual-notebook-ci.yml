name: Manual Notebook CI

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Execution profile"
        required: true
        default: "fast"
        type: choice
        options:
          - fast
          - full

jobs:
  execute-notebooks:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyyaml nbclient nbformat

      - name: Rebuild CI notebooks (RRN/ci_build)
        run: |
          rm -rf RRN/ci_build
          python scripts/notebook_transformer.py --target ci --force

      - name: Verify CI notebooks contain no Nexus-only magics
        run: |
          python - <<'PY'
          import glob
          import json
          import sys

          bad = []
          for path in sorted(glob.glob('RRN/ci_build/*.ipynb')):
              nb = json.loads(open(path, 'r', encoding='utf-8').read())
              for idx, cell in enumerate(nb.get('cells', []), start=1):
                  if cell.get('cell_type') != 'code':
                      continue
                  src = cell.get('source', '')
                  text = ''.join(src) if isinstance(src, list) else str(src)
                  if '%source' in text or 'kernel-activate' in text:
                      bad.append((path, idx))

          if bad:
              for path, idx in bad:
                  print(f"[ci] Nexus-only content still present: {path} cell {idx}")
              sys.exit(1)
          print('[ci] verified: no Nexus-only magics in CI notebooks')
          PY

      - name: Execute notebooks
        run: |
          SKIP_TAGS="ci-skip"
          if [ "${{ inputs.profile }}" = "fast" ]; then
            SKIP_TAGS="${SKIP_TAGS},slow"
          fi

          echo "[ci] using skip tags: ${SKIP_TAGS}"

          python scripts/execute_notebooks_ci.py \
            --glob "RRN/ci_build/*.ipynb" \
            --skip-tags "$SKIP_TAGS" \
            --timeout 1800
